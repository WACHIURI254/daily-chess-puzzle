<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Daily Chess Puzzle</title>

<!-- ‚úÖ Chess.js UMD build -->
<script src="https://cdn.jsdelivr.net/gh/jhlywa/chess.js@master/chess.min.js"></script>

<!-- ‚úÖ Chessboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css"/>

<style>
  body {
    font-family: Arial, sans-serif;
    text-align: center;
    background: #f4f4f4;
    margin: 0;
    padding: 20px;
  }
  h1 {
    color: #333;
  }
  #board {
    width: min(100%, 400px);
    margin: 20px auto;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    overflow: hidden;
  }
  #info {
    margin-top: 10px;
    background: #fff;
    padding: 15px 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    max-width: 400px;
    margin-left: auto;
    margin-right: auto;
  }
  #timer {
    color: #d9534f;
    font-weight: bold;
  }
  #status {
    color: #337ab7;
    font-weight: bold;
  }
  button {
    margin-top: 15px;
    padding: 10px 15px;
    font-size: 14px;
    border: none;
    border-radius: 6px;
    background: #337ab7;
    color: #fff;
    cursor: pointer;
  }
  button:hover {
    background: #286090;
  }
</style>
</head>
<body>
<h1>‚ôü Daily Chess Puzzle v3.0</h1>
<div id="board"></div>
<div id="info">
  <p><b>Difficulty:</b> <span id="difficulty">N/A</span></p>
  <p><b>Time:</b> <span id="timer">0s</span></p>
  <p id="status">Loading puzzle...</p>
  <button id="nextPuzzle">Next Puzzle</button>
</div>

<script>
const WORKER_URL = "https://chess-puzzle-proxy.kahitiedwin.workers.dev";

let game, solution, moveIndex = 0, board, timerInterval, seconds = 0;

function startTimer() {
  seconds = 0;
  clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    seconds++;
    document.getElementById("timer").innerText = seconds + "s";
  }, 1000);
}

async function loadPuzzle() {
  document.getElementById("status").innerText = "Loading puzzle...";
  document.getElementById("difficulty").innerText = "N/A";
  document.getElementById("timer").innerText = "0s";
  clearInterval(timerInterval);

  try {
    const res = await fetch(WORKER_URL);
    const data = await res.json();

    if (!res.ok) {
      throw new Error(data.error || `HTTP error: ${res.status}`);
    }

    game = new Chess();
    game.load_pgn(data.game.pgn);
    solution = data.puzzle.solution;
    moveIndex = 0;

    document.getElementById("difficulty").innerText = data.puzzle.rating;

    board = Chessboard('board', {
      position: game.fen(),
      draggable: true,
      onDrop: onDrop,
    });

    document.getElementById("status").innerText = "Make your move!";
    startTimer();

  } catch (err) {
    document.getElementById("status").innerText = "Failed to load puzzle.";
    console.error("Error loading puzzle:", err);
  }
}

function onDrop(source, target) {
  const move = game.move({ from: source, to: target, promotion: 'q' });

  if (move === null) {
    document.getElementById("status").innerText = "üõë Illegal move.";
    return 'snapback';
  }

  const uci = source + target;
  if (uci === solution[moveIndex]) {
    moveIndex++;

    if (moveIndex === solution.length) {
      document.getElementById("status").innerText = `üéâ Solved in ${seconds}s!`;
      clearInterval(timerInterval);
    } else {
      document.getElementById("status").innerText = "‚úÖ Correct! Opponent's turn...";
      setTimeout(() => {
        const opponentMove = solution[moveIndex];
        if (opponentMove) {
          game.move({ from: opponentMove.substring(0, 2), to: opponentMove.substring(2, 4), promotion: 'q' });
          board.position(game.fen());
          moveIndex++;
          if (moveIndex === solution.length) {
            document.getElementById("status").innerText = `üéâ Solved in ${seconds}s!`;
            clearInterval(timerInterval);
          } else {
            document.getElementById("status").innerText = "Your move!";
          }
        }
      }, 500);
    }
  } else {
    document.getElementById("status").innerText = "‚ùå Wrong move. Try again!";
    game.undo();
    board.position(game.fen());
  }
}

document.getElementById("nextPuzzle").addEventListener("click", loadPuzzle);

loadPuzzle();
</script>
</body>
</html>

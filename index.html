<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Daily Chess Puzzle (Offline piece images)</title>

  <!-- jQuery (required by chessboard.js v1) -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- chess.js (UMD build) -->
  <script src="https://cdn.jsdelivr.net/npm/chess.js@0.10.3/chess.min.js"></script>

  <!-- chessboard.js -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      padding: 28px;
      background: #f6f7fb;
      color: #111;
      margin: 0;
      min-height: 100vh;
      box-sizing: border-box;
    }
    h1 { margin: 0; font-size: 1.4rem; }
    #board { width: min(420px, 92vw); }
    #info {
      max-width: 420px;
      width: 92vw;
      background: white;
      padding: 12px 14px;
      border-radius: 10px;
      box-shadow: 0 6px 18px rgba(20,30,60,0.08);
      text-align: center;
    }
    button {
      margin-top: 8px;
      padding: 8px 12px;
      border: none;
      background: #2563eb;
      color: white;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
    }
    button:active { transform: translateY(1px); }
    #status { margin-top: 6px; color: #333; font-weight: 600; }
  </style>
</head>
<body>
  <h1>‚ôü Daily Chess Puzzle v8.0</h1>

  <div id="board"></div>

  <div id="info">
    <div><strong>Difficulty:</strong> <span id="difficulty">‚Äî</span></div>
    <div><strong>Time:</strong> <span id="timer">0s</span></div>
    <div id="status">Loading puzzle‚Ä¶</div>
    <div style="margin-top:8px">
      <button id="nextPuzzle">Next Puzzle</button>
    </div>
  </div>

<script>
/*
  Inline SVG "piece images" generator.
  We use SVG data URIs (utf8) so the browser makes NO image requests.
  The design: simple crisp glyphs (‚ôô‚ôñ‚ôò‚ôó‚ôï‚ôî / ‚ôü‚ôú‚ôû‚ôù‚ôõ‚ôö) centered in an SVG.
*/

// helper to create an SVG data URI (utf8, encoded)
function svgDataUri(svgString) {
  return 'data:image/svg+xml;utf8,' + encodeURIComponent(svgString);
}

// create SVG for a piece glyph (color: 'white' or 'black', glyph: unicode char)
function makePieceSVG(glyph, color) {
  const isWhite = color === 'white';
  const bg = isWhite ? '#ffffff' : 'transparent';
  const fg = isWhite ? '#111' : '#111';
  // Slight shadow/outline for contrast
  const outline = isWhite ? '#111' : '#fff';
  // SVG 45x45 (chessboard will scale)
  const svg = `
  <svg xmlns='http://www.w3.org/2000/svg' width='45' height='45' viewBox='0 0 45 45'>
    <rect width="45" height="45" fill="none"/>
    <g transform="translate(0,2)">
      <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle"
            font-family="sans-serif" font-size="28" font-weight="700"
            fill="${fg}" stroke="${outline}" stroke-width="0.8" paint-order="stroke">
        ${glyph}
      </text>
    </g>
  </svg>`;
  return svgDataUri(svg);
}

// map pieces to SVG URIs
const pieceImages = {
  wP: makePieceSVG('‚ôô','white'),
  wR: makePieceSVG('‚ôñ','white'),
  wN: makePieceSVG('‚ôò','white'),
  wB: makePieceSVG('‚ôó','white'),
  wQ: makePieceSVG('‚ôï','white'),
  wK: makePieceSVG('‚ôî','white'),
  bP: makePieceSVG('‚ôü','black'),
  bR: makePieceSVG('‚ôú','black'),
  bN: makePieceSVG('‚ôû','black'),
  bB: makePieceSVG('‚ôù','black'),
  bQ: makePieceSVG('‚ôõ','black'),
  bK: makePieceSVG('‚ôö','black')
};

// chessboard pieceTheme function using the inline SVGs
function pieceTheme(piece) {
  // chessboard.js passes the piece string like 'wP' or 'bK'
  return pieceImages[piece] || '';
}

/* --- Puzzle loader & UI (uses your Cloudflare Worker) --- */

const WORKER_URL = "https://chess-puzzle-proxy.kahitiedwin.workers.dev"; // no trailing slash

let game, board, solution, moveIndex = 0, timerInterval, seconds = 0;

function startTimer() {
  seconds = 0;
  clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    seconds++;
    document.getElementById('timer').innerText = seconds + 's';
  }, 1000);
}

async function loadPuzzle() {
  document.getElementById('status').innerText = 'Loading puzzle‚Ä¶';
  document.getElementById('difficulty').innerText = '‚Äî';
  document.getElementById('timer').innerText = '0s';
  clearInterval(timerInterval);

  try {
    const res = await fetch(WORKER_URL, { method: 'GET' });
    // If server returned non-JSON (or an error), this might throw
    const data = await res.json();

    if (!res.ok) {
      throw new Error(data && data.error ? data.error : `HTTP ${res.status}`);
    }

    // initialize Chess.js
    game = new Chess();
    // Lichess returns PGN; load it if present, otherwise try fen fallback
    if (data.game && data.game.pgn) {
      game.load_pgn(data.game.pgn);
    } else if (data.fen) {
      game.load(data.fen);
    } else {
      // If neither present, fail gracefully
      throw new Error('No game position in API response');
    }

    // solution array is typically uci moves like ["f3e5","e7e5","f2f3"]
    solution = (data.puzzle && data.puzzle.solution) ? data.puzzle.solution : [];
    moveIndex = 0;

    // render board (chessboard.js expects element id or element)
    if (board) {
      // if board exists, set new position
      board.position(game.fen());
    } else {
      board = Chessboard('board', {
        position: game.fen(),
        draggable: true,
        onDrop: onDrop,
        pieceTheme: pieceTheme // our inline SVGs
      });
    }

    document.getElementById('difficulty').innerText = (data.puzzle && data.puzzle.rating) ? data.puzzle.rating : '‚Äî';
    document.getElementById('status').innerText = 'Make your move!';
    startTimer();

  } catch (err) {
    console.error('Error loading puzzle:', err);
    document.getElementById('status').innerText = 'Failed to load puzzle.';
  }
}

// convert a move like from/to into Chess.js move and validate
function onDrop(source, target) {
  // Try move with promotion to queen by default
  const move = game.move({ from: source, to: target, promotion: 'q' });

  if (move === null) {
    document.getElementById('status').innerText = 'üõë Illegal move. Try again!';
    return 'snapback';
  }

  const uci = source + target; // e2e4 style (no promotion suffix)
  if (Array.isArray(solution) && uci === solution[moveIndex]) {
    moveIndex++;
    if (moveIndex === solution.length) {
      document.getElementById('status').innerText = `üéâ Puzzle solved in ${seconds}s!`;
      clearInterval(timerInterval);
    } else {
      document.getElementById('status').innerText = '‚úÖ Correct ‚Äî opponent move incoming...';
      // let opponent move
      setTimeout(() => {
        const opponent = solution[moveIndex];
        if (opponent) {
          game.move({ from: opponent.substring(0,2), to: opponent.substring(2,4), promotion: 'q' });
          board.position(game.fen());
          moveIndex++;
          if (moveIndex === solution.length) {
            document.getElementById('status').innerText = `üéâ Puzzle solved in ${seconds}s!`;
            clearInterval(timerInterval);
          } else {
            document.getElementById('status').innerText = 'Your move!';
          }
        }
      }, 450);
    }
  } else {
    // wrong move: undo and snap back
    document.getElementById('status').innerText = '‚ùå Wrong move. Undoing...';
    game.undo();
    board.position(game.fen());
  }
}

// wire the button
document.getElementById('nextPuzzle').addEventListener('click', loadPuzzle);

// initial load
loadPuzzle();

</script>
</body>
</html>
